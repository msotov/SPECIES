      PROGRAM RIJKL
      IMPLICIT REAL*4 (A-Z)
      DIMENSION HLAM(1221),WAVE(1221),HNU(1221),HNUCONT(1221)                                            
      DIMENSION AMAGI(13,1221),TRANSI(13,1221),EBVI(13),AMAG(1221)
      CHARACTER*80 TITLE
      INTEGER I,NH,NJ,NK,MODEL,MODEL1,MODEL2,NSKIP,NMODEL,ITEFF,NV
      INTEGER NU,IRED
      DIMENSION A(8)
      DIMENSION F(13000)
      DIMENSION VFILT(54),VWAVE(54)
      DIMENSION HATMOS(27),JATMOS(21),KATMOS(33)
      DIMENSION HDETEC(27),JDETEC(21),KDETEC(33)
      DIMENSION HTRANS(27),JTRANS(21),KTRANS(33)
      DIMENSION HBLOCK(27),JBLOCK(21),KBLOCK(33)
      DIMENSION HFILT(27),JFILT(21),KFILT(33)
      DIMENSION HWAVE(27),JWAVE(21),KWAVE(33)
      DIMENSION WAVEH(5400),WAVEJ(4200),WAVEK(6600),WAVEV(2700)
      DIMENSION SH(5400),SJ(4200),SK(6600),SV(2700)
      DATA NV,NH,NJ,NK/2700,5400,4200,6600/
      DATAVFILT/0.,.030,.084,.163,.301,.458,.630,.780,.895,.967,.997,1.,         
     1 .988,.958,.919,.877,.819,.765,.711,.657,.602,.545,.488,.434,.386,        
     2 .331,.289,.250,.214,.181,.151,.120,.093,.069,.051,.036,.027,.021,        
     3 .018,.016,.014,.012,.011,.010,.009,.008,.007,.006,.005,.004,.003,        
     4 .002,.001,.000/                                                          
      DATA HDETEC/27*1./
      DATA HBLOCK/27*1./
      DATA HATMOS/.000,.000,.000,.010,.160,.320,.480,.640,.780,.860,
     1 .860,.870,.870,.880,.880,.870,.870,.850,.840,.830,.810,.730,
     2 .400,.040,.020,.000,.000/
      DATA HFILT/.000,.000,.000,.010,.020,.050,.110,.280,.510,.710,
     1 .750,.790,.800,.795,.810,.810,.820,.820,.780,.800,.760,.730,
     2 .670,.640,.140,.050,.000/
      DATA JDETEC/ 21*1./
      DATA JBLOCK/ 21*1./
      DATA JATMOS/.830,.840,.840,.800,.600,.300,.840,.850,.860,.860,
     1 .860,.860,.860,.800,.750,.600,.000,.000,.000,.000,.000/
      DATA JFILT/.000,.000,.000,.010,.050,.200,.520,.690,.750,.750,.800,
     1 .830,.820,.750,.780,.780,.770,.790,.370,.010,.000/
      DATA KDETEC/33*1./
      DATA KBLOCK/.870,.869,.867,.865,.863,.861,.857,.853,.849,.845,
     1 .841,.837,.833,.830,.824,.818,.814,.810,.806,.802,.800,.798,.796,
     2 .794,.790,.787,.783,.779,.775,.771,.765,.759,.751/
      DATA KATMOS/.010,.05,.480,.690,.830,.690,.880,.850,.870,.900,.950,
     1 .960,.950,.950,.930,.950,.980,.970,.920,.900,.910,.910,.870,.860,
     2 .860,.850,.830,.780,.750,.610,.510,.440,.400/
      DATA KFILT/.000,.004,.008,.020,.055,.149,.412,.725,.882,.882,.824,
     1 .878,.851,.808,.878,.882,.914,.914,.871,.902,.906,.855,.859,.871,
     2 .804,.882,.588,.149,.047,.012,.000,.000,.000/
      DATA VWAVE/475.,480.,485.,490.,495.,500.,505.,510.,515.,520.,525.,         
     1 530.,535.,540.,545.,550.,555.,560.,565.,570.,575.,580.,585.,590.,        
     2 595.,600.,605.,610.,615.,620.,625.,630.,635.,640.,645.,650.,655.,        
     3 660.,665.,670.,675.,680.,685.,690.,695.,700.,705.,710.,715.,720.,        
     4 725.,730.,735.,740./                                                     
      DATA HWAVE/1340.,1360.,1380.,1400.,1420.,1440.,1460.,1480.,1500.,
     1 1520.,1540.,1560.,1580.,1600.,1620.,1640.,1680.,1700.,1720.,
     2 1740.,1760.,1780.,1800.,1820.,1840.,1860.,1880./
      DATA JWAVE/1040.,1060.,1080.,1100.,1120.,1140.,1160.,1180.,1200.,
     1 1220.,1240.,1260.,1280.,1300.,1320.,1340.,1360.,1380.,1400.,
     2 1420.,1440./
      DATA KWAVE/1900.,1920.,1940.,1960.,1980.,2000.,2020.,2040.,2060.,
     1     2080.,2100.,2120.,2140.,2160.,2180.,2200.,2220.,2240.,2260.,
     2     2280.,2300.,2320.,2340.,2360.,2380.,2400.,2420.,2440.,2460.,
     3     2480.,2500.,2520.,2540./
C      DATA EBVI/0.,.1,.2,.3,.4,.5,.6,.7,.8,.9,1./
      DATA EBVI/0.,.1,.2,.3,.4,.5,.6,.8,1.,2.,3.,4.,5./
   77 FORMAT(10E12.4)
      DO 5 I=1,21      
    5 JTRANS(I)=JFILT(I)*JDETEC(I)*JBLOCK(I)*JATMOS(I)
      DO 6 I=1,27      
    6 HTRANS(I)=HFILT(I)*HDETEC(I)*HBLOCK(I)*HATMOS(I)
      DO 7 I=1,33      
    7 KTRANS(I)=KFILT(I)*KDETEC(I)*KBLOCK(I)*KATMOS(I)
      DO 312 I=1,NV
  312 WAVEV(I)=VWAVE(1)+FLOAT(I)*.1
      DO 12 I=1,NH
   12 WAVEH(I)=HWAVE(1)+FLOAT(I)*.1
      DO 13 I=1,NJ
   13 WAVEJ(I)=JWAVE(1)+FLOAT(I)*.1
      DO 14 I=1,NK
   14 WAVEK(I)=KWAVE(1)+FLOAT(I)*.1
      CALL PINTER(VWAVE,VFILT,54,WAVEV,SV,NV)
      CALL LINTER(HWAVE,HTRANS,27,WAVEH,SH,NH)
      CALL LINTER(JWAVE,JTRANS,21,WAVEJ,SJ,NJ)
      CALL LINTER(KWAVE,KTRANS,33,WAVEK,SK,NK)
      VNORM=0.
      DO 315 I=1,NV
  315 VNORM=VNORM+MAX(SV(I),0.)
      VNORM=VNORM*.1
      HNORM=0.
      DO 16 I=1,NH
   16 HNORM=HNORM+MAX(SH(I),0.)
      HNORM=HNORM*.1
      JNORM=0.
      DO 17 I=1,NJ
   17 JNORM=JNORM+MAX(SJ(I),0.)
      JNORM=JNORM*.1
      KNORM=0.
      DO 117 I=1,NK
  117 KNORM=KNORM+MAX(SK(I),0.)
      KNORM=KNORM*.1
      VNOMAG=-2.5*ALOG10(VNORM)                                                
      HNOMAG=-2.5*ALOG10(HNORM)
      JNOMAG=-2.5*ALOG10(JNORM)
      KNOMAG=-2.5*ALOG10(KNORM)
C
C
CSDSC GRID  [+0.0]  VTURB 2.0 KM/S   L/H 1.25
      READ(1,555)ABUND,VTURB,CONVEC
  555 FORMAT(12X,F4.1,8X,F4.1,11X,F5.2)
      DO 616 ISKIP=1,21
  616 READ(1,1)
C     wavelength in nm
      READ(1,1)WAVE
    1 FORMAT(8F10.2)
      RV=3.1
      EBV=.1
C     CALL REDDENING(WAVE,RV,EBV,AMAG)
      READ(2,344)
      READ(2,344)
      DO 366 NU=1,1221
  366 READ(2,344)
      READ(2,344)
      EBVI(1)=0.
      READ(2,344)(EBVI(IRED),IRED=2,13)
  344 FORMAT(10X,12F10.1)
      DO 367 NU=1,1221
      TRANSI(1,NU)=1.
      READ(2,359)(TRANSI(IRED,NU),IRED=2,13)
  359 FORMAT(13X,12E10.3)
  367 CONTINUE
      WRITE(6,666)
      WRITE(7,666)
      WRITE(8,666)
  666 FORMAT('        Teff log g  [M]  Vturb  l/H  E(B-V)',
     1'  VMOD    JMOD    HMOD    KMOD      V       J       H       K'
     2 '      V-J     V-H     V-K')
C      DO 1000 NMODEL=1,2                                              
      DO 1000 NMODEL=1,1000                                              
C     ergs/cm**2/s/hz/ster
      READ(1,2,END=9)TITLE
    2 FORMAT(A80)
      PRINT 713,MODEL,TITLE
  713 FORMAT(I5,1X,A80)
      READ(TITLE,'(5X,I6,10X,F8.5)')ITEFF,GLOG
C     ergs/cm**2/s/hz/ster
      READ(1,4)Hnu
      READ(1,4)HnuCONT
    4 FORMAT(8E10.4)
      NNU=1221
      DO 900 IRED=1,13
      DO 715 NU=1,1221
      FREQ=2.99792458E17/WAVE(NU)
  715 HLAM(NU)=HNU(NU)*FREQ/WAVE(NU)*TRANSI(IRED,NU)

C     PRINT 77,(WAVE(I),HLAM(I),I=1,NNU)                                        
      CALL LINTER(WAVE,HLAM,NNU,WAVEV,F,NV)
C     PRINT 77,F
      VF=0.
      DO 322 I=1,NV
  322 VF=VF+SV(I)*F(I)
      VF=VF*.1
      CALL LINTER(WAVE,HLAM,NNU,WAVEH,F,NH)
      HF=0.
      DO 32 I=1,NH
   32 HF=HF+SH(I)*F(I)
      HF=HF*.1
      CALL LINTER(WAVE,HLAM,NNU,WAVEJ,F,NJ)
      JF=0.
      DO 42 I=1,NJ
   42 JF=JF+SJ(I)*F(I)
      JF=JF*.1
      CALL LINTER(WAVE,HLAM,NNU,WAVEK,F,NK)
      KF=0.
      DO 142 I=1,NK
  142 KF=KF+SK(I)*F(I)
      KF=KF*.1
      VMAG=-2.5*ALOG10(VF)
      HMAG=-2.5*ALOG10(HF)
      JMAG=-2.5*ALOG10(JF)
      KMAG=-2.5*ALOG10(KF)
      VMAG=VMAG-VNOMAG
      HMAG=HMAG-HNOMAG
      JMAG=JMAG-JNOMAG
      KMAG=KMAG-KNOMAG
C     NORMALIZATION TO 9550,3.95,2,-0.5=VEGA   V=+0.030 H=0 J=0 K=0
C     V       J       H       K      
C  -19.151 -16.444 -15.397 -14.226 
      VMAGVEGA=VMAG+19.151+.030
      HMAGVEGA=HMAG+15.397
      JMAGVEGA=JMAG+16.444
      KMAGVEGA=KMAG+14.226
      VMINH=VMAGVEGA-HMAGVEGA
      VMINJ=VMAGVEGA-JMAGVEGA
      VMINK=VMAGVEGA-KMAGVEGA
      XSCALE=ABUND
c     actually l/h
      xh=CONVEC
      if(ItEFF.GE.9000)xh=0.
      WRITE(6,60)NMODEL,ITEFF,GLOG,XSCALE,VTURB,XH,EBVI(IRED),
     1VMAG,JMAG,HMAG,KMAG,VMAGVEGA,JMAGVEGA,HMAGVEGA,KMAGVEGA,
     2VMINJ,VMINH,VMINK
      WRITE(7,60)NMODEL,ITEFF,GLOG,XSCALE,VTURB,XH,EBVI(IRED),
     1VMAG,JMAG,HMAG,KMAG,VMAGVEGA,JMAGVEGA,HMAGVEGA,KMAGVEGA,
     2VMINJ,VMINH,VMINK
      IF(IRED.EQ.1)
     1WRITE(8,60)NMODEL,ITEFF,GLOG,XSCALE,VTURB,XH,EBVI(IRED),
     1VMAG,JMAG,HMAG,KMAG,VMAGVEGA,JMAGVEGA,HMAGVEGA,KMAGVEGA,
     2VMINJ,VMINH,VMINK
   60 FORMAT(I6,I6,5F6.2,11F8.3)
  900 CONTINUE
 1000 CONTINUE
    9 CALL EXIT
      END
      SUBROUTINE LINTER(XOLD,YOLD,NOLD,XNEW,YNEW,NNEW)
      DIMENSION XOLD(1),YOLD(1),XNEW(1),YNEW(1)
C     XOLD AND XNEW INCREASING
      IOLD=2
      DO 2 INEW=1,NNEW
    1 IF(XNEW(INEW).LT.XOLD(IOLD))GO TO 2
      IF(IOLD.EQ.NOLD)GO TO 2
      IOLD=IOLD+1
      GO TO 1
    2 YNEW(INEW)=YOLD(IOLD-1)+(YOLD(IOLD)-YOLD(IOLD-1))/
     1(XOLD(IOLD)-XOLD(IOLD-1))*(XNEW(INEW)-XOLD(IOLD-1))
      RETURN
      END
      SUBROUTINE PINTER(XOLD,FOLD,NOLD,XNEW,FNEW,NNEW)
      DIMENSION XOLD(1),FOLD(1),XNEW(1),FNEW(1)
      L=2
      LL=0
      DO 50 K=1,NNEW
   10 IF(XNEW(K).LT.XOLD(L))GO TO 20
      L=L+1
      IF(L.GT.NOLD)GO TO 30
      GO TO 10
   20 IF(L.EQ.LL)GO TO 50
      IF(L.EQ.2)GO TO 30
      L1=L-1
      IF(L.GT.LL+1.OR.L.EQ.3)GO TO 21
      CBAC=CFOR
      BBAC=BFOR
      ABAC=AFOR
      IF(L.EQ.NOLD)GO TO 22
      GO TO 25
   21 L2=L-2
      D=(FOLD(L1)-FOLD(L2))/(XOLD(L1)-XOLD(L2))
      CBAC=FOLD(L)/((XOLD(L)-XOLD(L1))*(XOLD(L)-XOLD(L2)))+
     1(FOLD(L2)/(XOLD(L)-XOLD(L2))-FOLD(L1)/(XOLD(L)-XOLD(L1)))/
     2(XOLD(L1)-XOLD(L2))
      BBAC=D-(XOLD(L1)+XOLD(L2))*CBAC
      ABAC=FOLD(L2)-XOLD(L2)*D+XOLD(L1)*XOLD(L2)*CBAC
      IF(L.LT.NOLD)GO TO 25
   22 C=CBAC
      B=BBAC
      A=ABAC
      LL=L
      GO TO 50
   25 D=(FOLD(L)-FOLD(L1))/(XOLD(L)-XOLD(L1))
      CFOR=FOLD(L+1)/((XOLD(L+1)-XOLD(L))*(XOLD(L+1)-XOLD(L1)))+
     1(FOLD(L1)/(XOLD(L+1)-XOLD(L1))-FOLD(L)/(XOLD(L+1)-XOLD(L)))/
     2(XOLD(L)-XOLD(L1))
      BFOR=D-(XOLD(L)+XOLD(L1))*CFOR
      AFOR=FOLD(L1)-XOLD(L1)*D+XOLD(L)*XOLD(L1)*CFOR
      WT=0.
      IF(ABS(CFOR).NE.0.)WT=ABS(CFOR)/(ABS(CFOR)+ABS(CBAC))
      A=AFOR+WT*(ABAC-AFOR)
      B=BFOR+WT*(BBAC-BFOR)
      C=CFOR+WT*(CBAC-CFOR)
      LL=L
      GO TO 50
   30 IF(L.EQ.LL)GO TO 50
      L=AMIN0(NOLD,L)
      C=0.
      B=(FOLD(L)-FOLD(L-1))/(XOLD(L)-XOLD(L-1))
      A=FOLD(L)-XOLD(L)*B
      LL=L
   50 FNEW(K)=A+(B+C*XNEW(K))*XNEW(K)
      MAP1=LL-1
      RETURN
      END
